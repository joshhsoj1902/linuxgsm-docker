defaults: &defaults 
    working_directory: ~/build
    docker: 
      - image: joshhsoj1902/circleci-build-image:1.0.8@sha256:87c9fcce5f5474f34407f12640fd89903070e4de467724294e687a4442d2fe0c
swarm_test: &swarm_test
    name: Start container & run tests
    command: | 
      docker swarm init
      docker stack deploy --compose-file ./docker-stack.yml game
      retry -v -s 5 -t 60 'docker exec $(docker ps -q) "./docker-ready.sh"'
      retry -v -s 5 -t 10 'docker exec $(docker ps -q) "./docker-health.sh"'
version: 2.1

orbs:
    docker: joshhsoj1902/docker@0.0.1

jobs:
  setup:
    <<: *defaults
    steps:
      - checkout
      - run: 
          name: setup workspace
          command: |
            cp -rp docker-compose.citest.yml docker-stack.yml Makefile scripts examples /tmp/workspace
            ls -ltr /tmp/workspace
            ls -ltr /tmp/workspace/examples
      - persist_to_workspace:
          root: /tmp/workspace
          paths: 
            - docker-compose.citest.yml
            - docker-stack.yml
            - examples
            - Makefile
            - scripts

  swarm:
    <<: *defaults
    steps:
      - setup_remote_docker:
          version: 17.11.0-ce
      - attach_workspace:
          at: /tmp/workspace
      - run: docker load -i /tmp/workspace/images.tar
      - run: cp /tmp/workspace/docker-stack.yml ./docker-stack.yml
      - run: docker tag joshhsoj1902/linuxgsm-docker:latest joshhsoj1902/linuxgsm-docker:local
      - run:
          <<: *swarm_test
workflows:
  version: 2
  build_and_test:
    jobs:
      - setup
      - docker/build:
          context: org-global
          tag: latest
          requires: 
            - setup
      - docker/test:
          name: gomplate tests
          requires:
            - docker/build          
      - swarm:
          name: swarm-test
          requires:
            - docker/build
      - docker/compose-test-health:
          name: compose-test
          composeFile: docker-compose.citest.yml
          service: game
          requires:
            - docker/build
    ### 7dtd ###    
      - docker/compose-test-health:
          name: 7dtd-compose
          composeFile: examples/docker-compose.7dtd.yml
          service: game
          requires:
            - swarm-test
            - compose-test 
    ### ARK ###    
      # - docker/compose-test-health:
      #     name: ark-compose
      #     composeFile: examples/docker-compose.ark.yml
      #     service: game
      #     requires:
      #       - swarm-test
      #       - compose-test  
    ### CSGO ###    
    ## This game is 20GB, that's slow to install every time (and I feel kinda bad using that much so often)
      # - docker/compose-test-health:
      #     name: csgo-compose
      #     composeFile: examples/docker-compose.csgo.yml
      #     service: game
      #     requires:
      #       - swarm-test
      #       - compose-test  
    ### CSS ###    
      - docker/compose-test-health:
          name: css-compose
          composeFile: examples/docker-compose.css.yml
          service: game
          requires:
            - swarm-test
            - compose-test  
    ### GMOD ###    
      - docker/compose-test-health:
          name: gmod-compose
          composeFile: examples/docker-compose.gmod.yml
          service: game
          requires:
            - swarm-test
            - compose-test
    ### INSS ###     
      - docker/compose-test-health:
          name: inss-compose
          composeFile: examples/docker-compose.inss.yml
          service: game
          requires:
            - swarm-test
            - compose-test   
    ### Minecraft ###     
      - docker/compose-test-health:
          name: minecraft-compose
          composeFile: examples/docker-compose.minecraft.yml
          service: game
          requires:
            - swarm-test
            - compose-test  
    ### Mumble ###   
#      - docker/compose-test-health:
#          name: mumble-compose
#          composeFile: examples/docker-compose.mumble.yml
#          service: game
#          requires:
#            - swarm-test
#            - compose-test  
    ### Pstbs ###   
      - docker/compose-test-health:
          name: pstbs-compose
          composeFile: examples/docker-compose.pstbs.yml
          service: game
          requires:
            - swarm-test
            - compose-test
    ### Wet ###   
      - docker/compose-test-health:
          name: wet-compose
          composeFile: examples/docker-compose.wet.yml
          service: game
          requires:
            - swarm-test
            - compose-test
    ### Wurm ###   
      # - docker/compose-test-health:
      #     name: wurm-compose
      #     composeFile: examples/docker-compose.wurm.yml
      #     service: game
      #     requires:
      #       - swarm-test
      #       - compose-test

